var e=this&&this.__awaiter||function(e,t,n,a){return new(n||(n=Promise))((function(r,o){function i(e){try{s(a.next(e))}catch(e){o(e)}}function l(e){try{s(a.throw(e))}catch(e){o(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,l)}s((a=a.apply(e,t||[])).next())}))},t=this&&this.__generator||function(e,t){var n,a,r,o,i={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:l(0),throw:l(1),return:l(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function l(l){return function(s){return function(l){if(n)throw new TypeError("Generator is already executing.");for(;o&&(o=0,l[0]&&(i=0)),i;)try{if(n=1,a&&(r=2&l[0]?a.return:l[0]?a.throw||((r=a.return)&&r.call(a),0):a.next)&&!(r=r.call(a,l[1])).done)return r;switch(a=0,r&&(l=[2&l[0],r.value]),l[0]){case 0:case 1:r=l;break;case 4:return i.label++,{value:l[1],done:0};case 5:i.label++,a=l[1],l=[0];continue;case 7:l=i.ops.pop(),i.trys.pop();continue;default:if(!(r=i.trys,(r=r.length>0&&r[r.length-1])||6!==l[0]&&2!==l[0])){i=0;continue}if(3===l[0]&&(!r||l[1]>r[0]&&l[1]<r[3])){i.label=l[1];break}if(6===l[0]&&i.label<r[1]){i.label=r[1],r=l;break}if(r&&i.label<r[2]){i.label=r[2],i.ops.push(l);break}r[2]&&i.ops.pop(),i.trys.pop();continue}l=t.call(e,i)}catch(e){l=[6,e],a=0}finally{n=r=0}if(5&l[0])throw l[1];return{value:l[0]?l[1]:void 0,done:1}}([l,s])}}};Object.defineProperty(exports,"__esModule",{value:1});var n=require("htmlparser2"),a=require("@libs/fetch"),r=require("@libs/filterInputs"),o=require("@libs/novelStatus"),i=function(){function i(){this.id="royalroad",this.name="Royal Road",this.version="2.0.0",this.icon="src/en/royalroad/icon.png",this.site="https://www.royalroad.com/",this.filters={order:{value:"weekly-popular",label:"Order By",options:[{label:"Best Rated",value:"best-rated"},{label:"Trending",value:"trending"},{label:"Ongoing Fictions",value:"active-popular"},{label:"Complete",value:"complete"},{label:"Popular this week",value:"weekly-popular"},{label:"Latest Updates",value:"latest-updates"},{label:"Newest Fictions",value:"new"},{label:"Rising Stars",value:"rising-stars"},{label:"Writathon",value:"writathon"}],type:r.FilterTypes.Picker},genre:{value:"",label:"Genres",options:[{label:"ALL",value:""},{label:"Action",value:"action"},{label:"Adventure",value:"adventure"},{label:"Comedy",value:"comedy"},{label:"Contemporary",value:"contemporary"},{label:"Drama",value:"drama"},{label:"Fantasy",value:"fantasy"},{label:"Historical",value:"historical"},{label:"Horror",value:"horror"},{label:"Mystery",value:"mystery"},{label:"Psychological",value:"psychological"},{label:"Romance",value:"romance"},{label:"Satire",value:"satire"},{label:"Sci-fi",value:"sci_fi"},{label:"Short Story",value:"one_shot"},{label:"Tragedy",value:"tragedy"}],type:r.FilterTypes.Picker}}}return i.prototype.parseNovels=function(e){var t=[],a={name:""},r=0,o=0,i=new n.Parser({onopentag:function(e,n){var i,l;(null===(i=n.class)||void 0===i?void 0:i.includes("fiction-list-item"))&&(r=1),r&&("a"===e&&(null===(l=n.class)||void 0===l?void 0:l.includes("bold"))&&(a.path=n.href.slice(1),o=1),"img"===e&&(a.cover=n.src),a.path&&a.name&&(t.push(a),(a={}).name=""))},ontext:function(e){o&&(a.name+=e)},onclosetag:function(e){"h2"===e&&(o=0,r=0)}});return i.write(e),i.end(),t},i.prototype.popularNovels=function(n,r){var o=r.filters;return e(this,void 0,void 0,(function(){var e,r;return t(this,(function(t){switch(t.label){case 0:return e="".concat(this.site,"fictions/"),e+=o.order.value,e+="?page=".concat(n),""!==o.genre.value&&(e+="&genre=".concat(o.genre.value)),[4,(0,a.fetchApi)(e).then((function(e){return e.text()}))];case 1:return r=t.sent(),[2,this.parseNovels(r)]}}))}))},i.prototype.parseNovel=function(r){var i;return e(this,void 0,void 0,(function(){var e,l,s,u,c,p,v,d,h,f,b,y,m,w,g,N;return t(this,(function(t){switch(t.label){case 0:return[4,(0,a.fetchApi)(this.site+r)];case 1:return[4,t.sent().text()];case 2:switch(e=t.sent(),l={path:r,name:"",summary:"",chapters:[]},s=0,u=0,c=0,p=0,v=0,d=0,h=0,f=[],b=0,y=0,m=[],w=[],g=new n.Parser({onopentag:function(e,t){var n,a,r;"img"===e&&(null===(n=t.class)||void 0===n?void 0:n.includes("thumbnail"))&&(l.cover=t.src),"span"===e&&(null===(a=t.class)||void 0===a?void 0:a.includes("label-sm"))&&v++,"span"===e&&(null===(r=t.class)||void 0===r?void 0:r.includes("tags"))&&(d=1)},onopentagname:function(e){"h1"===e&&(s=1),p&&"a"===e&&(u=1),d&&"a"===e&&(h=1),"label"===e&&(c=0,d=0),b&&"script"===e&&(y=1)},onattribute:function(e,t){"class"===e&&"description"===t&&(c=1),"class"===e&&"page-footer footer"===t&&(b=1)},ontext:function(e){s&&(l.name=e),u&&(l.author=e,u=0),c&&(l.summary+=e),2===v&&(l.status=e.trim(),v++),h&&f.push(e),y&&e.includes("window.chapters =")&&(m=JSON.parse(e.match(/window.chapters = (.+])(?=;)/)[1]),w=JSON.parse(e.match(/window.volumes = (.+])(?=;)/)[1]))},onclosetag:function(e){"h1"===e&&(s=0,p=1),"h4"===e&&(p=0),"a"===e&&(h=0),"script"===e&&(y=0),"body"===e&&(b=0)}}),g.write(e),g.end(),l.summary=null===(i=l.summary)||void 0===i?void 0:i.trim(),l.genres=f.join(", "),l.status){case"ONGOING":l.status=o.NovelStatus.Ongoing;break;case"HIATUS":l.status=o.NovelStatus.OnHiatus;break;case"COMPLETED":l.status=o.NovelStatus.Completed;break;default:l.status=o.NovelStatus.Unknown}return N=m.map((function(e){var t=w.find((function(t){return t.id===e.volumeId}));return{name:e.title,path:e.url.slice(1),releaseTime:e.date,chapterNumber:null==e?void 0:e.order,page:null==t?void 0:t.title}})),l.chapters=N,[2,l]}}))}))},i.prototype.parseChapter=function(r){return e(this,void 0,void 0,(function(){var e,o,i,l,s,u,c,p;return t(this,(function(t){switch(t.label){case 0:return[4,(0,a.fetchApi)(this.site+r)];case 1:return[4,t.sent().text()];case 2:return e=t.sent(),o="",i=0,l=0,s=0,u=0,c="",(p=new n.Parser({onopentag:function(e,t){if(i&&"div"===e){var n=t.style;n?(o+='<div style="'.concat(n,'">'),u=1):o+="<div>"}if(i&&"table"===e){var a=t.width;o+=a?'<table width="'.concat(a,'">'):"<table>"}if(i&&"tbody"===e&&(o+="<tbody>"),i&&"tr"===e&&(o+="<tr>"),i&&"td"===e){var r=t.width;o+=r?'<td width="'.concat(r,'">'):"<td>"}},onattribute:function(e,t){"class"===e&&"chapter-inner chapter-content"===t&&(i=1),"class"===e&&"portlet light t-center-3"===t&&(i=0,l=0),"class"===e&&t===c&&(l=0)},onopentagname:function(e){i&&"p"===e&&(o+="<p>",l=1,u&&(u=0)),"style"===e&&(s=1),i&&"br"===e&&(o+="<br>")},ontext:function(e){l&&(o+=e),u&&(o+=e),s&&e.includes("display: none;")&&(c=e.match(/\.(.*)\{/)[1])},onclosetag:function(e){"p"===e&&(l=0,o+="</p>"),"style"===e&&(s=0),i&&"td"===e&&(o+="</td>"),i&&"tr"===e&&(o+="</tr>"),i&&"tbody"===e&&(o+="</tbody>"),i&&"table"===e&&(o+="</table>"),i&&"div"===e&&(u=0,o+="</div>")}})).write(e),p.end(),[2,o]}}))}))},i.prototype.searchNovels=function(n,r){return e(this,void 0,void 0,(function(){var e,o;return t(this,(function(t){switch(t.label){case 0:return e="".concat(this.site,"fictions/search?page=").concat(r,"&title=").concat(n),[4,(0,a.fetchApi)(e).then((function(e){return e.text()}))];case 1:return o=t.sent(),[2,this.parseNovels(o)]}}))}))},i.prototype.fetchImage=function(n){return e(this,void 0,void 0,(function(){return t(this,(function(e){return[2,(0,a.fetchFile)(n)]}))}))},i}();exports.default=new i;