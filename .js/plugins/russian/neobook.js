var e=this&&this.__awaiter||function(e,t,l,a){return new(l||(l=Promise))((function(n,o){function r(e){try{u(a.next(e))}catch(e){o(e)}}function i(e){try{u(a.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?n(e.value):(t=e.value,t instanceof l?t:new l((function(e){e(t)}))).then(r,i)}u((a=a.apply(e,t||[])).next())}))},t=this&&this.__generator||function(e,t){var l,a,n,o,r={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return o={next:i(0),throw:i(1),return:i(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function i(i){return function(u){return function(i){if(l)throw new TypeError("Generator is already executing.");for(;o&&(o=0,i[0]&&(r=0)),r;)try{if(l=1,a&&(n=2&i[0]?a.return:i[0]?a.throw||((n=a.return)&&n.call(a),0):a.next)&&!(n=n.call(a,i[1])).done)return n;switch(a=0,n&&(i=[2&i[0],n.value]),i[0]){case 0:case 1:n=i;break;case 4:return r.label++,{value:i[1],done:0};case 5:r.label++,a=i[1],i=[0];continue;case 7:i=r.ops.pop(),r.trys.pop();continue;default:if(!(n=r.trys,(n=n.length>0&&n[n.length-1])||6!==i[0]&&2!==i[0])){r=0;continue}if(3===i[0]&&(!n||i[1]>n[0]&&i[1]<n[3])){r.label=i[1];break}if(6===i[0]&&r.label<n[1]){r.label=n[1],n=i;break}if(n&&r.label<n[2]){r.label=n[2],r.ops.push(i);break}n[2]&&r.ops.pop(),r.trys.pop();continue}i=t.call(e,r)}catch(e){i=[6,e],a=0}finally{l=n=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:1}}([i,u])}}};Object.defineProperty(exports,"__esModule",{value:1});var l=require("@libs/filterInputs"),a=require("@libs/defaultCover"),n=require("@libs/fetch"),o=require("@libs/novelStatus"),r={0:o.NovelStatus.Unknown,1:o.NovelStatus.Ongoing,2:o.NovelStatus.Completed,3:o.NovelStatus.OnHiatus,4:o.NovelStatus.Cancelled},i=function(){function i(){var e=this;this.id="neobook",this.name="Neobook",this.site="https://neobook.org",this.version="1.0.1",this.icon="src/ru/neobook/icon.png",this.popularNovels=this.fetchNovels,this.fetchImage=n.fetchFile,this.resolveUrl=function(t,l){return e.site+(l?"/book/":"/reader/")+t},this.filters={sort:{label:"Сортировка:",value:"popular",options:[{label:"Сначала популярные",value:"popular"},{label:"Сначала новые",value:"new"},{label:"В случайном порядке",value:"rand"}],type:l.FilterTypes.Picker},timeread:{label:"Время прочтения:",value:"0-999999",options:[{label:"Все",value:"0-999999"},{label:"Менее 15 минут",value:"0-900"},{label:"15-30 минут",value:"900-1800"},{label:"30-60 минут",value:"1800-3600"},{label:"1-2 часа",value:"3600-7200"},{label:"Более 2 часов",value:"7200-999999"}],type:l.FilterTypes.Picker},category:{label:"Жанр:",value:"",options:[{label:"Все",value:""},{label:"Антиутопия",value:"10"},{label:"Детектив",value:"13"},{label:"Детские книги",value:"14"},{label:"Драма",value:"15"},{label:"Другое",value:"16"},{label:"История",value:"18"},{label:"Мелодрама",value:"21"},{label:"Мистика",value:"22"},{label:"Научная фантастика",value:"23"},{label:"Нон-фикшн",value:"35"},{label:"Подростки и молодежь",value:"26"},{label:"Постапокалипсис",value:"27"},{label:"Поэзия",value:"28"},{label:"Приключения",value:"29"},{label:"Рассказ",value:"34"},{label:"Роман",value:"36"},{label:"Творчество",value:"40"},{label:"Триллер",value:"91"},{label:"Ужасы",value:"90"},{label:"Фантастика",value:"41"},{label:"Фанфик",value:"42"},{label:"Фэнтези",value:"44"},{label:"Эротика",value:"46"},{label:"Юмор",value:"47"}],type:l.FilterTypes.Picker},tags:{label:"Тэги:",value:"",type:l.FilterTypes.TextInput}}}return i.prototype.fetchNovels=function(l,o,r){var i,u,s,v,c,p,d=o.filters,h=o.showLatestNovels;return e(this,void 0,void 0,(function(){var e,o,f;return t(this,(function(t){switch(t.label){case 0:return(e=new FormData).append("version","4.0"),e.append("uid","0"),e.append("utoken",""),e.append("resource","general"),e.append("action","get_bundle"),e.append("bundle","bundle_books"),e.append("target","feed"),e.append("page",l.toString()),e.append("filter_category_id",(null===(i=null==d?void 0:d.category)||void 0===i?void 0:i.value)||"0"),e.append("filter_completed","-1"),e.append("filter_search",r||""),e.append("filter_tags",(null===(u=null==d?void 0:d.tags)||void 0===u?void 0:u.value)||""),e.append("filter_sort",h?"new":(null===(s=null==d?void 0:d.sort)||void 0===s?void 0:s.value)||"popular"),e.append("filter_timeread",(null===(v=null==d?void 0:d.timeread)||void 0===v?void 0:v.value)||"0-999999"),[4,(0,n.fetchApi)("https://api.neobook.org/",{method:"post",body:e}).then((function(e){return e.json()}))];case 1:return o=t.sent().bundle_books,f=[],(null===(c=o.feed)||void 0===c?void 0:c.length)&&(null===(p=o.feed)||void 0===p||p.forEach((function(e){var t,l;return f.push({name:e.title,cover:(null===(l=null===(t=null==e?void 0:e.attachment)||void 0===t?void 0:t.image)||void 0===l?void 0:l.m)||a.defaultCover,path:e.token+"/"})}))),[2,f]}}))}))},i.prototype.searchNovels=function(l,a){return e(this,void 0,void 0,(function(){var e;return t(this,(function(t){return e={filters:void 0,showLatestNovels:0},[2,this.fetchNovels(a,e,l)]}))}))},i.prototype.parseNovel=function(l){var i,u,s,v,c,p,d;return e(this,void 0,void 0,(function(){var e,h,f,b,m;return t(this,(function(t){switch(t.label){case 0:return[4,(0,n.fetchApi)(this.resolveUrl(l,1)).then((function(e){return e.text()}))];case 1:return e=t.sent(),h={path:l,name:"",cover:a.defaultCover},(f=e.match(/var postData = ({.*?});/))instanceof Array&&f[1]&&(b=JSON.parse(f[1]),h.name=b.title,h.summary=(null===(u=null===(i=b.text)||void 0===i?void 0:i.replace)||void 0===u?void 0:u.call(i,/<br>/g,"\n"))||b.text_fix,h.author=b.user&&b.user.firstname&&b.user.lastname?b.user.firstname+" "+b.user.lastname:(null===(s=b.user)||void 0===s?void 0:s.initials)||"",h.status=r[b.status||"0"]||o.NovelStatus.Unknown,(null===(c=null===(v=b.attachment)||void 0===v?void 0:v.image)||void 0===c?void 0:c.m)&&(h.cover=b.attachment.image.m),(null===(p=b.tags)||void 0===p?void 0:p.length)&&(h.genres=b.tags.join(",")),m=[],null===(d=b.chapters)||void 0===d||d.forEach((function(e,t){"1"==e.access&&"1"==e.status&&m.push({name:e.title||"Глава "+(t+1),path:"?book=".concat(b.token,"&chapter=").concat(e.token),releaseTime:null,chapterNumber:Number(e.sort)||t+1})})),h.chapters=m),[2,h]}}))}))},i.prototype.parseChapter=function(l){var a,o,r;return e(this,void 0,void 0,(function(){var e,i,u,s,v,c;return t(this,(function(t){switch(t.label){case 0:return[4,(0,n.fetchApi)(this.resolveUrl(l)).then((function(e){return e.text()}))];case 1:return e=t.sent(),i=e.match(/var data = ({.*?});/),u="",i instanceof Array&&i[1]&&(s=l.split("=")[2],v=JSON.parse(i[1]),c=null===(o=null===(a=v.chapters)||void 0===a?void 0:a.find)||void 0===o?void 0:o.call(a,(function(e){return e.token==s})),u=((null===(r=null==c?void 0:c.data)||void 0===r?void 0:r.html)||"").replace(/<br>/g,"")),[2,u]}}))}))},i}();exports.default=new i;